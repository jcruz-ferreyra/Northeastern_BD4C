mutate(address = gsub(" ave.$", " ave", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub("dry dock", "drydock", address)) %>%
mutate(address = gsub("v f w", "vfw", address)) %>%
mutate(address = gsub("st thomas mo.*re.*$", "saint thomas more rd", address)) %>%
mutate(address = ifelse(!word(address, -1) %in% suffixes, paste0(address, " st"), address)) %>%
mutate(address = gsub("street st", "st", address)) %>%
mutate(address = gsub("st st", "st", address)) %>%
mutate(address = gsub("sq sq", "sq", address)) %>%
mutate(address = gsub("la grange", "lagrange", address)) %>%
mutate(address = gsub("truman highway", "truman parkway", address)) %>%
mutate(address = gsub("guest$", "guest st", address)) %>%
mutate(address = gsub("mass ave$", "massachusetts ave", address)) %>%
mutate(address = gsub("government center st", "government center", address)) %>%
mutate(address = gsub("louis pasteur st", "louis pasteur", address)) %>%
mutate(address = gsub("boston fish pier st", "fish pier", address)) %>%
mutate(address = gsub("waterside.*", "waterside drive", address)) %>%
mutate(address = gsub("lafayette st", "lafayette", address)) %>%
mutate(address = gsub(".*charles river dam.*", "charles river dam", address)) %>%
mutate(address = gsub("first$", "first st", address)) %>%
mutate(address = gsub("columbus st", "columbus ave", address)) %>%
mutate(address = gsub("east$", "east st", address)) %>%
mutate(address = gsub("kington", "kingston", address)) %>%
mutate(address = gsub("longwood st", "longwood ave", address))
df_address %>%
filter(str_detect(tolower(address), "first")) %>%
pull(address) %>%
unique()
df_address <- df_address %>%
mutate(address_query = paste0(tolower(address), ", Boston, Massachusetts", if_else(zip_code==", NA", "", zip_code)))
# df_address_geocoded <- data.frame()
df_address_ungeocoded <- df_address %>%
filter(!(original_address%in%(df_address_geocoded$original_address)))
df_address_geocoded
df_address_ungeocoded <- df_address_ungeocoded %>%
filter(!(str_detect(tolower(address), "citywide"))) %>%
filter(!(str_detect(tolower(address), "logan"))) %>%
filter(!(str_detect(tolower(address), "lewis mall"))) %>%
filter(!(str_detect(tolower(address), "vfw"))) %>%
filter(!(str_detect(tolower(address), "common"))) %>%
filter(!(str_detect(tolower(address), "providence"))) %>%
filter(!(str_detect(tolower(address), "m l king"))) %>%
filter(!(str_detect(tolower(address), "amer legion"))) %>%
filter(!(str_detect(tolower(address), "international p"))) %>%
filter(!(str_detect(tolower(address), "fhmp"))) %>%
filter(!(str_detect(tolower(address), "island"))) %>%
filter(!(str_detect(tolower(address), "embankment"))) %>%
filter(!(str_detect(tolower(address), "yawkey"))) %>%
filter(!(str_detect(tolower(address), "kelly s"))) %>%
filter(!(str_detect(tolower(address), "circuit"))) %>%
filter(!(str_detect(tolower(address), "terminal"))) %>%
filter(!(str_detect(tolower(address), "420 west"))) %>%
filter(!(str_detect(tolower(address), "station"))) %>%
filter(!(str_detect(tolower(address), "kinley"))) %>%
filter(!(str_detect(tolower(address), "charles river dam"))) %>%
filter(!(str_detect(tolower(address), "accolon"))) %>%
filter(!(str_detect(tolower(address), "exeter"))) %>%
filter(!(str_detect(tolower(address), "fleet")))
batch_size <- 32
for (i in seq(1, nrow(df_address), by = batch_size)) {
batch_rows <- df_address_ungeocoded[i:min(i+batch_size-1, nrow(df_address_ungeocoded)), ]
geocoded_batch <- pmap(list(batch_rows$address_query), geocode_df) %>%
reduce(rbind)
geocoded_batch <- geocoded_batch %>%
left_join(
batch_rows[c("address_query", "original_address")],
by = c("address"="address_query")
)
df_address_geocoded <- rbind(df_address_geocoded, geocoded_batch)
cat("Processed rows", i, "to", min(i+batch_size-1, nrow(df_address_ungeocoded)), "\n")
# Optional: Save intermediate results to a file to avoid data loss if a crash happens
# write.csv(geocoded_df, "geocoded_df_intermediate.csv", row.names = FALSE)
}
df_address <- df_address %>%
mutate(address = gsub("\\s+", " ", address)) %>%
mutate(address = gsub(" wm t morrissey  bl$", " william t morrissey blvd", address)) %>%
mutate(address = gsub(".*faneuil hall.*$", "10 north market st", address)) %>%
mutate(address = gsub("1.*financial.*$", "180 summer st", address)) %>%
mutate(address = gsub("washington.*$", "washington st", address)) %>%
mutate(address = gsub("trmnl", "terminal", address)) %>%
mutate(address = gsub(" wy$", " way", address)) %>%
mutate(address = gsub(" wa$", " way", address)) %>%
mutate(address = gsub(" av$", " ave", address)) %>%
mutate(address = gsub(" bl$", " blvd", address)) %>%
mutate(address = gsub(" ct$", " st", address)) %>%
mutate(address = gsub(" pkwy$", " parkway", address)) %>%
mutate(address = gsub(" hwy$", " highway", address)) %>%
mutate(address = gsub(" hw$", " highway", address)) %>%
mutate(address = gsub(" wh$", " wharf", address)) %>%
mutate(address = gsub(" whf$", " wharf", address)) %>%
mutate(address = gsub(" pk$", " park", address)) %>%
mutate(address = gsub(" cr$", " st", address)) %>%
mutate(address = gsub(" ro$", " row", address)) %>%
mutate(address = gsub(" pl$", " place", address)) %>%
mutate(address = gsub(" plz$", " plaza", address)) %>%
mutate(address = gsub(" pz$", " plaza", address)) %>%
mutate(address = gsub(" pw$", " parkway", address)) %>%
mutate(address = gsub(" building (fhmp)$", " ", address)) %>%
mutate(address = gsub(" m l king$", " m l king blvd", address)) %>%
mutate(address = gsub(" la$", " lane", address)) %>%
mutate(address = gsub(" ln$", " lane", address)) %>%
mutate(address = gsub(" av ex$", " ave extension", address)) %>%
mutate(address = gsub(" te$", " terrace", address)) %>%
mutate(address = gsub(" cir$", " st", address)) %>%
mutate(address = gsub(" pr$", " park", address)) %>%
mutate(address = gsub(" dm$", " dam", address)) %>%
mutate(address = gsub(" ave.$", " ave", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub("dry dock", "drydock", address)) %>%
mutate(address = gsub("v f w", "vfw", address)) %>%
mutate(address = gsub("st thomas mo.*re.*$", "saint thomas more rd", address)) %>%
mutate(address = ifelse(!word(address, -1) %in% suffixes, paste0(address, " st"), address)) %>%
mutate(address = gsub("street st", "st", address)) %>%
mutate(address = gsub("st st", "st", address)) %>%
mutate(address = gsub("sq sq", "sq", address)) %>%
mutate(address = gsub("la grange", "lagrange", address)) %>%
mutate(address = gsub("truman highway", "truman parkway", address)) %>%
mutate(address = gsub("guest$", "guest st", address)) %>%
mutate(address = gsub("mass ave$", "massachusetts ave", address)) %>%
mutate(address = gsub("government center st", "government center", address)) %>%
mutate(address = gsub("louis pasteur st", "louis pasteur", address)) %>%
mutate(address = gsub("boston fish pier st", "fish pier", address)) %>%
mutate(address = gsub("waterside.*", "waterside drive", address)) %>%
mutate(address = gsub("lafayette st", "lafayette", address)) %>%
mutate(address = gsub(".*charles river dam.*", "charles river dam", address)) %>%
mutate(address = gsub("first$", "first st", address)) %>%
mutate(address = gsub("columbus st", "columbus ave", address)) %>%
mutate(address = gsub("east$", "east st", address)) %>%
mutate(address = gsub("kington", "kingston", address)) %>%
mutate(address = gsub("longwood st", "longwood ave", address)) %>%
mutate(address = gsub("pi alley st", "pi alley", address))
df_address %>%
filter(str_detect(tolower(address), "first")) %>%
pull(address) %>%
unique()
df_address <- df_address %>%
mutate(address_query = paste0(tolower(address), ", Boston, Massachusetts", if_else(zip_code==", NA", "", zip_code)))
# df_address_geocoded <- data.frame()
df_address_ungeocoded <- df_address %>%
filter(!(original_address%in%(df_address_geocoded$original_address)))
df_address_geocoded
df_address_ungeocoded <- df_address_ungeocoded %>%
filter(!(str_detect(tolower(address), "citywide"))) %>%
filter(!(str_detect(tolower(address), "logan"))) %>%
filter(!(str_detect(tolower(address), "lewis mall"))) %>%
filter(!(str_detect(tolower(address), "vfw"))) %>%
filter(!(str_detect(tolower(address), "common"))) %>%
filter(!(str_detect(tolower(address), "providence"))) %>%
filter(!(str_detect(tolower(address), "m l king"))) %>%
filter(!(str_detect(tolower(address), "amer legion"))) %>%
filter(!(str_detect(tolower(address), "international p"))) %>%
filter(!(str_detect(tolower(address), "fhmp"))) %>%
filter(!(str_detect(tolower(address), "island"))) %>%
filter(!(str_detect(tolower(address), "embankment"))) %>%
filter(!(str_detect(tolower(address), "yawkey"))) %>%
filter(!(str_detect(tolower(address), "kelly s"))) %>%
filter(!(str_detect(tolower(address), "circuit"))) %>%
filter(!(str_detect(tolower(address), "terminal"))) %>%
filter(!(str_detect(tolower(address), "420 west"))) %>%
filter(!(str_detect(tolower(address), "station"))) %>%
filter(!(str_detect(tolower(address), "kinley"))) %>%
filter(!(str_detect(tolower(address), "charles river dam"))) %>%
filter(!(str_detect(tolower(address), "accolon"))) %>%
filter(!(str_detect(tolower(address), "exeter"))) %>%
filter(!(str_detect(tolower(address), "fleet")))
batch_size <- 32
for (i in seq(1, nrow(df_address), by = batch_size)) {
batch_rows <- df_address_ungeocoded[i:min(i+batch_size-1, nrow(df_address_ungeocoded)), ]
geocoded_batch <- pmap(list(batch_rows$address_query), geocode_df) %>%
reduce(rbind)
geocoded_batch <- geocoded_batch %>%
left_join(
batch_rows[c("address_query", "original_address")],
by = c("address"="address_query")
)
df_address_geocoded <- rbind(df_address_geocoded, geocoded_batch)
cat("Processed rows", i, "to", min(i+batch_size-1, nrow(df_address_ungeocoded)), "\n")
# Optional: Save intermediate results to a file to avoid data loss if a crash happens
# write.csv(geocoded_df, "geocoded_df_intermediate.csv", row.names = FALSE)
}
df_address %>%
filter(str_detect(tolower(address), "first")) %>%
pull(address) %>%
unique()
df_address <- df_address %>%
mutate(address_query = paste0(tolower(address), ", Boston, Massachusetts", if_else(zip_code==", NA", "", zip_code)))
# df_address_geocoded <- data.frame()
df_address_ungeocoded <- df_address %>%
filter(!(original_address%in%(df_address_geocoded$original_address)))
df_address_geocoded
df_address_ungeocoded <- df_address_ungeocoded %>%
filter(!(str_detect(tolower(address), "citywide"))) %>%
filter(!(str_detect(tolower(address), "logan"))) %>%
filter(!(str_detect(tolower(address), "lewis mall"))) %>%
filter(!(str_detect(tolower(address), "vfw"))) %>%
filter(!(str_detect(tolower(address), "common"))) %>%
filter(!(str_detect(tolower(address), "providence"))) %>%
filter(!(str_detect(tolower(address), "m l king"))) %>%
filter(!(str_detect(tolower(address), "amer legion"))) %>%
filter(!(str_detect(tolower(address), "international p"))) %>%
filter(!(str_detect(tolower(address), "fhmp"))) %>%
filter(!(str_detect(tolower(address), "island"))) %>%
filter(!(str_detect(tolower(address), "embankment"))) %>%
filter(!(str_detect(tolower(address), "yawkey"))) %>%
filter(!(str_detect(tolower(address), "kelly s"))) %>%
filter(!(str_detect(tolower(address), "circuit"))) %>%
filter(!(str_detect(tolower(address), "terminal"))) %>%
filter(!(str_detect(tolower(address), "420 west"))) %>%
filter(!(str_detect(tolower(address), "station"))) %>%
filter(!(str_detect(tolower(address), "kinley"))) %>%
filter(!(str_detect(tolower(address), "charles river dam"))) %>%
filter(!(str_detect(tolower(address), "accolon"))) %>%
filter(!(str_detect(tolower(address), "exeter"))) %>%
filter(!(str_detect(tolower(address), "fleet"))) %>%
filter(!(str_detect(tolower(address), "pittsburg")))
batch_size <- 32
for (i in seq(1, nrow(df_address), by = batch_size)) {
batch_rows <- df_address_ungeocoded[i:min(i+batch_size-1, nrow(df_address_ungeocoded)), ]
geocoded_batch <- pmap(list(batch_rows$address_query), geocode_df) %>%
reduce(rbind)
geocoded_batch <- geocoded_batch %>%
left_join(
batch_rows[c("address_query", "original_address")],
by = c("address"="address_query")
)
df_address_geocoded <- rbind(df_address_geocoded, geocoded_batch)
cat("Processed rows", i, "to", min(i+batch_size-1, nrow(df_address_ungeocoded)), "\n")
# Optional: Save intermediate results to a file to avoid data loss if a crash happens
# write.csv(geocoded_df, "geocoded_df_intermediate.csv", row.names = FALSE)
}
df_address <- df_address %>%
mutate(address = gsub("\\s+", " ", address)) %>%
mutate(address = gsub(" wm t morrissey  bl$", " william t morrissey blvd", address)) %>%
mutate(address = gsub(".*faneuil hall.*$", "10 north market st", address)) %>%
mutate(address = gsub("1.*financial.*$", "180 summer st", address)) %>%
mutate(address = gsub("washington.*$", "washington st", address)) %>%
mutate(address = gsub("trmnl", "terminal", address)) %>%
mutate(address = gsub(" wy$", " way", address)) %>%
mutate(address = gsub(" wa$", " way", address)) %>%
mutate(address = gsub(" av$", " ave", address)) %>%
mutate(address = gsub(" bl$", " blvd", address)) %>%
mutate(address = gsub(" ct$", " st", address)) %>%
mutate(address = gsub(" pkwy$", " parkway", address)) %>%
mutate(address = gsub(" hwy$", " highway", address)) %>%
mutate(address = gsub(" hw$", " highway", address)) %>%
mutate(address = gsub(" wh$", " wharf", address)) %>%
mutate(address = gsub(" whf$", " wharf", address)) %>%
mutate(address = gsub(" pk$", " park", address)) %>%
mutate(address = gsub(" cr$", " st", address)) %>%
mutate(address = gsub(" ro$", " row", address)) %>%
mutate(address = gsub(" pl$", " place", address)) %>%
mutate(address = gsub(" plz$", " plaza", address)) %>%
mutate(address = gsub(" pz$", " plaza", address)) %>%
mutate(address = gsub(" pw$", " parkway", address)) %>%
mutate(address = gsub(" building (fhmp)$", " ", address)) %>%
mutate(address = gsub(" m l king$", " m l king blvd", address)) %>%
mutate(address = gsub(" la$", " lane", address)) %>%
mutate(address = gsub(" ln$", " lane", address)) %>%
mutate(address = gsub(" av ex$", " ave extension", address)) %>%
mutate(address = gsub(" te$", " terrace", address)) %>%
mutate(address = gsub(" cir$", " st", address)) %>%
mutate(address = gsub(" pr$", " park", address)) %>%
mutate(address = gsub(" dm$", " dam", address)) %>%
mutate(address = gsub(" ave.$", " ave", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub("dry dock", "drydock", address)) %>%
mutate(address = gsub("v f w", "vfw", address)) %>%
mutate(address = gsub("st thomas mo.*re.*$", "saint thomas more rd", address)) %>%
mutate(address = ifelse(!word(address, -1) %in% suffixes, paste0(address, " st"), address)) %>%
mutate(address = gsub("street st", "st", address)) %>%
mutate(address = gsub("st st", "st", address)) %>%
mutate(address = gsub("sq sq", "sq", address)) %>%
mutate(address = gsub("la grange", "lagrange", address)) %>%
mutate(address = gsub("truman highway", "truman parkway", address)) %>%
mutate(address = gsub("guest$", "guest st", address)) %>%
mutate(address = gsub("mass ave$", "massachusetts ave", address)) %>%
mutate(address = gsub("government center st", "government center", address)) %>%
mutate(address = gsub("louis pasteur st", "louis pasteur", address)) %>%
mutate(address = gsub("boston fish pier st", "fish pier", address)) %>%
mutate(address = gsub("waterside.*", "waterside drive", address)) %>%
mutate(address = gsub("lafayette st", "lafayette", address)) %>%
mutate(address = gsub(".*charles river dam.*", "charles river dam", address)) %>%
mutate(address = gsub("first$", "first st", address)) %>%
mutate(address = gsub("columbus st", "columbus ave", address)) %>%
mutate(address = gsub("east$", "east st", address)) %>%
mutate(address = gsub("kington", "kingston", address)) %>%
mutate(address = gsub("longwood st", "longwood ave", address)) %>%
mutate(address = gsub("pi alley st", "pi alley", address)) %>%
mutate(address = gsub("fish pier st", "fish pier rd", address))
df_address %>%
filter(str_detect(tolower(address), "first")) %>%
pull(address) %>%
unique()
df_address <- df_address %>%
mutate(address_query = paste0(tolower(address), ", Boston, Massachusetts", if_else(zip_code==", NA", "", zip_code)))
# df_address_geocoded <- data.frame()
df_address_ungeocoded <- df_address %>%
filter(!(original_address%in%(df_address_geocoded$original_address)))
df_address_geocoded
df_address_ungeocoded <- df_address_ungeocoded %>%
filter(!(str_detect(tolower(address), "citywide"))) %>%
filter(!(str_detect(tolower(address), "logan"))) %>%
filter(!(str_detect(tolower(address), "lewis mall"))) %>%
filter(!(str_detect(tolower(address), "vfw"))) %>%
filter(!(str_detect(tolower(address), "common"))) %>%
filter(!(str_detect(tolower(address), "providence"))) %>%
filter(!(str_detect(tolower(address), "m l king"))) %>%
filter(!(str_detect(tolower(address), "amer legion"))) %>%
filter(!(str_detect(tolower(address), "international p"))) %>%
filter(!(str_detect(tolower(address), "fhmp"))) %>%
filter(!(str_detect(tolower(address), "island"))) %>%
filter(!(str_detect(tolower(address), "embankment"))) %>%
filter(!(str_detect(tolower(address), "yawkey"))) %>%
filter(!(str_detect(tolower(address), "kelly s"))) %>%
filter(!(str_detect(tolower(address), "circuit"))) %>%
filter(!(str_detect(tolower(address), "terminal"))) %>%
filter(!(str_detect(tolower(address), "420 west"))) %>%
filter(!(str_detect(tolower(address), "station"))) %>%
filter(!(str_detect(tolower(address), "kinley"))) %>%
filter(!(str_detect(tolower(address), "charles river dam"))) %>%
filter(!(str_detect(tolower(address), "accolon"))) %>%
filter(!(str_detect(tolower(address), "exeter"))) %>%
filter(!(str_detect(tolower(address), "fleet"))) %>%
filter(!(str_detect(tolower(address), "pittsburg")))
batch_size <- 32
for (i in seq(1, nrow(df_address), by = batch_size)) {
batch_rows <- df_address_ungeocoded[i:min(i+batch_size-1, nrow(df_address_ungeocoded)), ]
geocoded_batch <- pmap(list(batch_rows$address_query), geocode_df) %>%
reduce(rbind)
geocoded_batch <- geocoded_batch %>%
left_join(
batch_rows[c("address_query", "original_address")],
by = c("address"="address_query")
)
df_address_geocoded <- rbind(df_address_geocoded, geocoded_batch)
cat("Processed rows", i, "to", min(i+batch_size-1, nrow(df_address_ungeocoded)), "\n")
# Optional: Save intermediate results to a file to avoid data loss if a crash happens
# write.csv(geocoded_df, "geocoded_df_intermediate.csv", row.names = FALSE)
}
# Geocode data
df_address <- df[c("address", "zip_code")] %>%
filter(duplicated(address) == FALSE) %>%
filter(!is.na(address)) %>%
mutate(original_address = address) %>%
mutate(address = tolower(address))
suffixes <- c("st", "way", "ave", "sq", "pl", "plaza", "dr", "blvd", "rd", "b", "e", "c", "d", "highway", "island", "wharf", "park", "parkway", "lane", "extension", "terrace", "dam", "south", "street", "row", "cornhill", "arborway", "place", "avenue")
df_address <- df_address %>%
mutate(address = gsub("\\s+", " ", address)) %>%
mutate(address = gsub(" wm t morrissey  bl$", " william t morrissey blvd", address)) %>%
mutate(address = gsub(".*faneuil hall.*$", "10 north market st", address)) %>%
mutate(address = gsub("1.*financial.*$", "180 summer st", address)) %>%
mutate(address = gsub("washington.*$", "washington st", address)) %>%
mutate(address = gsub("trmnl", "terminal", address)) %>%
mutate(address = gsub(" wy$", " way", address)) %>%
mutate(address = gsub(" wa$", " way", address)) %>%
mutate(address = gsub(" av$", " ave", address)) %>%
mutate(address = gsub(" bl$", " blvd", address)) %>%
mutate(address = gsub(" ct$", " st", address)) %>%
mutate(address = gsub(" pkwy$", " parkway", address)) %>%
mutate(address = gsub(" hwy$", " highway", address)) %>%
mutate(address = gsub(" hw$", " highway", address)) %>%
mutate(address = gsub(" wh$", " wharf", address)) %>%
mutate(address = gsub(" whf$", " wharf", address)) %>%
mutate(address = gsub(" pk$", " park", address)) %>%
mutate(address = gsub(" cr$", " st", address)) %>%
mutate(address = gsub(" ro$", " row", address)) %>%
mutate(address = gsub(" pl$", " place", address)) %>%
mutate(address = gsub(" plz$", " plaza", address)) %>%
mutate(address = gsub(" pz$", " plaza", address)) %>%
mutate(address = gsub(" pw$", " parkway", address)) %>%
mutate(address = gsub(" building (fhmp)$", " ", address)) %>%
mutate(address = gsub(" m l king$", " m l king blvd", address)) %>%
mutate(address = gsub(" la$", " lane", address)) %>%
mutate(address = gsub(" ln$", " lane", address)) %>%
mutate(address = gsub(" av ex$", " ave extension", address)) %>%
mutate(address = gsub(" te$", " terrace", address)) %>%
mutate(address = gsub(" cir$", " st", address)) %>%
mutate(address = gsub(" pr$", " park", address)) %>%
mutate(address = gsub(" dm$", " dam", address)) %>%
mutate(address = gsub(" ave.$", " ave", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub(" pier 4 ", " pier four ", address)) %>%
mutate(address = gsub("dry dock", "drydock", address)) %>%
mutate(address = gsub("v f w", "vfw", address)) %>%
mutate(address = gsub("st thomas mo.*re.*$", "saint thomas more rd", address)) %>%
mutate(address = ifelse(!word(address, -1) %in% suffixes, paste0(address, " st"), address)) %>%
mutate(address = gsub("street st", "st", address)) %>%
mutate(address = gsub("st st", "st", address)) %>%
mutate(address = gsub("sq sq", "sq", address)) %>%
mutate(address = gsub("la grange", "lagrange", address)) %>%
mutate(address = gsub("truman highway", "truman parkway", address)) %>%
mutate(address = gsub("guest$", "guest st", address)) %>%
mutate(address = gsub("mass ave$", "massachusetts ave", address)) %>%
mutate(address = gsub("government center st", "government center", address)) %>%
mutate(address = gsub("louis pasteur st", "louis pasteur", address)) %>%
mutate(address = gsub("boston fish pier st", "fish pier", address)) %>%
mutate(address = gsub("waterside.*", "waterside drive", address)) %>%
mutate(address = gsub("lafayette st", "lafayette", address)) %>%
mutate(address = gsub(".*charles river dam.*", "charles river dam", address)) %>%
mutate(address = gsub("first$", "first st", address)) %>%
mutate(address = gsub("columbus st", "columbus ave", address)) %>%
mutate(address = gsub("east$", "east st", address)) %>%
mutate(address = gsub("kington", "kingston", address)) %>%
mutate(address = gsub("longwood st", "longwood ave", address)) %>%
mutate(address = gsub("pi alley st", "pi alley", address)) %>%
mutate(address = gsub("fish pier st", "fish pier rd", address)) %>%
mutate(address = gsub("walnut pk st", "walnut park", address))
df_address %>%
filter(str_detect(tolower(address), "first")) %>%
pull(address) %>%
unique()
df_address <- df_address %>%
mutate(address_query = paste0(tolower(address), ", Boston, Massachusetts", if_else(zip_code==", NA", "", zip_code)))
# df_address_geocoded <- data.frame()
df_address_ungeocoded <- df_address %>%
filter(!(original_address%in%(df_address_geocoded$original_address)))
df_address_geocoded
df_address_ungeocoded <- df_address_ungeocoded %>%
filter(!(str_detect(tolower(address), "citywide"))) %>%
filter(!(str_detect(tolower(address), "logan"))) %>%
filter(!(str_detect(tolower(address), "lewis mall"))) %>%
filter(!(str_detect(tolower(address), "vfw"))) %>%
filter(!(str_detect(tolower(address), "common"))) %>%
filter(!(str_detect(tolower(address), "providence"))) %>%
filter(!(str_detect(tolower(address), "m l king"))) %>%
filter(!(str_detect(tolower(address), "amer legion"))) %>%
filter(!(str_detect(tolower(address), "international p"))) %>%
filter(!(str_detect(tolower(address), "fhmp"))) %>%
filter(!(str_detect(tolower(address), "island"))) %>%
filter(!(str_detect(tolower(address), "embankment"))) %>%
filter(!(str_detect(tolower(address), "yawkey"))) %>%
filter(!(str_detect(tolower(address), "kelly s"))) %>%
filter(!(str_detect(tolower(address), "circuit"))) %>%
filter(!(str_detect(tolower(address), "terminal"))) %>%
filter(!(str_detect(tolower(address), "420 west"))) %>%
filter(!(str_detect(tolower(address), "station"))) %>%
filter(!(str_detect(tolower(address), "kinley"))) %>%
filter(!(str_detect(tolower(address), "charles river dam"))) %>%
filter(!(str_detect(tolower(address), "accolon"))) %>%
filter(!(str_detect(tolower(address), "exeter"))) %>%
filter(!(str_detect(tolower(address), "fleet"))) %>%
filter(!(str_detect(tolower(address), "pittsburg")))
batch_size <- 32
for (i in seq(1, nrow(df_address), by = batch_size)) {
batch_rows <- df_address_ungeocoded[i:min(i+batch_size-1, nrow(df_address_ungeocoded)), ]
geocoded_batch <- pmap(list(batch_rows$address_query), geocode_df) %>%
reduce(rbind)
geocoded_batch <- geocoded_batch %>%
left_join(
batch_rows[c("address_query", "original_address")],
by = c("address"="address_query")
)
df_address_geocoded <- rbind(df_address_geocoded, geocoded_batch)
cat("Processed rows", i, "to", min(i+batch_size-1, nrow(df_address_ungeocoded)), "\n")
# Optional: Save intermediate results to a file to avoid data loss if a crash happens
# write.csv(geocoded_df, "geocoded_df_intermediate.csv", row.names = FALSE)
}
df_address %>%
filter(str_detect(tolower(address), "first")) %>%
pull(address) %>%
unique()
df_address <- df_address %>%
mutate(address_query = paste0(tolower(address), ", Boston, Massachusetts", if_else(zip_code==", NA", "", zip_code)))
# df_address_geocoded <- data.frame()
df_address_ungeocoded <- df_address %>%
filter(!(original_address%in%(df_address_geocoded$original_address)))
df_address_geocoded
df_address_ungeocoded <- df_address_ungeocoded %>%
filter(!(str_detect(tolower(address), "citywide"))) %>%
filter(!(str_detect(tolower(address), "logan"))) %>%
filter(!(str_detect(tolower(address), "lewis mall"))) %>%
filter(!(str_detect(tolower(address), "vfw"))) %>%
filter(!(str_detect(tolower(address), "common"))) %>%
filter(!(str_detect(tolower(address), "providence"))) %>%
filter(!(str_detect(tolower(address), "m l king"))) %>%
filter(!(str_detect(tolower(address), "amer legion"))) %>%
filter(!(str_detect(tolower(address), "international p"))) %>%
filter(!(str_detect(tolower(address), "fhmp"))) %>%
filter(!(str_detect(tolower(address), "island"))) %>%
filter(!(str_detect(tolower(address), "embankment"))) %>%
filter(!(str_detect(tolower(address), "yawkey"))) %>%
filter(!(str_detect(tolower(address), "kelly s"))) %>%
filter(!(str_detect(tolower(address), "circuit"))) %>%
filter(!(str_detect(tolower(address), "terminal"))) %>%
filter(!(str_detect(tolower(address), "420 west"))) %>%
filter(!(str_detect(tolower(address), "station"))) %>%
filter(!(str_detect(tolower(address), "kinley"))) %>%
filter(!(str_detect(tolower(address), "charles river dam"))) %>%
filter(!(str_detect(tolower(address), "accolon"))) %>%
filter(!(str_detect(tolower(address), "exeter"))) %>%
filter(!(str_detect(tolower(address), "fleet"))) %>%
filter(!(str_detect(tolower(address), "pittsburg")))
batch_size <- 32
for (i in seq(1, nrow(df_address_ungeocoded), by = batch_size)) {
batch_rows <- df_address_ungeocoded[i:min(i+batch_size-1, nrow(df_address_ungeocoded)), ]
geocoded_batch <- pmap(list(batch_rows$address_query), geocode_df) %>%
reduce(rbind)
geocoded_batch <- geocoded_batch %>%
left_join(
batch_rows[c("address_query", "original_address")],
by = c("address"="address_query")
)
df_address_geocoded <- rbind(df_address_geocoded, geocoded_batch)
cat("Processed rows", i, "to", min(i+batch_size-1, nrow(df_address_ungeocoded)), "\n")
# Optional: Save intermediate results to a file to avoid data loss if a crash happens
# write.csv(geocoded_df, "geocoded_df_intermediate.csv", row.names = FALSE)
}
View(df_address_geocoded)
write.csv(df_address_geocoded, "D:/Documentos/Data/2024_Northeastern/BD4C/data/partial.csv")
